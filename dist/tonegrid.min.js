/*!
 * MatrixTones
 * -----------
 * Matrix sequencer by Web Audio API
 *
 * @version 0.1.1 (2014-11-11)
 * @author mach3 <http://github.com/mach3>
 * @license MIT
 * @url https://github.com/mach3/tonegrid.js
 */
!function(a,b){if(b.AudioContext=b.AudioContext||b.webkitAudioContext||null,!b.AudioContext)return b.ToneGrid=null;var c=function(){this.init.apply(this,arguments)};!function(){var b=c.prototype;b.defaults={offset:1,prefix:"tonegrid",speed:120,easing:8,major:!0,type:"sine"},b.options=null,b.$el=null,b.playing=!1,b.timer=null,b.index=-1,b.frames=null,b.tones=null,b.data=null,b.init=function(b,c){var e;d.events(this),d.config(this),d.rebase(this,["process","initData","onClick"]),e=this.config(c),this.$el=a(b).addClass(e.prefix),this.render(),this.initTones(),this.initData(),this.$el.on("change","input[type=checkbox]",this.initData),this.on("change",this.onChange),d.iOS()&&this.$el.on("click",this.onClick)},b.initTones=function(){var a,b,d;a=this,b=this.getFrequencies(),d=this.options,this.tones?b.forEach(function(b,c){a.tones[c].config({easing:d.easing,frequency:b,type:d.type})}):(this.tones=[],b.forEach(function(b,e){var f=new c.Tone(e,{frequency:b,easing:d.easing,type:d.type});a.tones.push(f)}))},b.getFrequencies=function(){var a,b,c;return a=this.options,b=[a.offset-22],c=a.major?[2,2,3,2,3]:[2,1,4,3,2],d.times(4,function(){c.forEach(function(a){b.push(d.last(b)+a)})}),b=b.slice(0,20),b.map(function(a){return 440*Math.pow(1.05946309436,a-1)}).reverse()},b.initData=function(){var b=[];this.frames.each(function(){var c=[];a(this).find("input").each(function(){this.checked&&c.push(parseInt(this.value,10))}),b.push(c)}),this.data=b},b.render=function(){var b,c,e;b=this.options,c=a("<div>"),e=function(c,d){return a("<label>").append(a("<input>",{name:"frame-"+d,type:"checkbox",value:c}),a("<span>",{"class":b.prefix+"-label"}).append(a("<span>",{"class":b.prefix+"-label-inner"})))},d.times(20,function(f){var g=a("<div>",{"class":b.prefix+"-frame","data-name":f});d.times(20,function(a){e(a,f).appendTo(g)}),g.appendTo(c)}),c.children().appendTo(this.$el),this.frames=this.$el.find(d.format(".%s-frame",b.prefix))},b.play=function(){this.playing=!0,clearInterval(this.timer),this.timer=setInterval(this.process,parseInt(6e4/this.config("speed")/4,10))},b.stop=function(){this.playing=!1,clearInterval(this.timer)},b.process=function(){var a,b,c;a=this.options,b=this,this.playing&&(c=this.index=(this.index+1)%20,this.frames.removeClass("active").eq(c).addClass("active"),this.data[c].forEach(function(a){b.tones[a].tone()}))},b.onChange=function(a,b){return["offset","major","easing","type"].indexOf(b.key)>=0?this.initTones():void("speed"===b.key&&this.play())},b.onClick=function(){this.tones.forEach(function(a){a.play()}),this.$el.off("click",this.onClick)},b.toJSON=function(){return{data:this.data,options:d.filter(this.config(),function(a,b){return["speed","offset","easing","major"].indexOf(b)>=0}),frequencies:this.getFrequencies()}},b.toMIDI=function(){return void 0}}(),c.context=null,c.Tone=function(){this.init.apply(this,arguments)},function(){var a=c.Tone.prototype;a.defaults={easing:8,frequency:440,type:"sine"},a.index=null,a.playing=!1,a.ctx=null,a.osc=null,a.gain=null,a.timer=null,a.flag=!1,a.init=function(a,b){d.events(this),d.config(this),d.rebase(this,["process","onChange"]),c.context||(c.context=new AudioContext),this.index=a,this.ctx=c.context,this.osc=this.ctx.createOscillator(),this.gain=this.ctx.createGain(),this.osc.connect(this.gain),this.gain.connect(this.ctx.destination),this.gain.gain.value=0,this.on("change",this.onChange),this.config(b),this.play()},a.onChange=function(a,b){if(this.osc)switch(b.key){case"frequency":this.osc.frequency.value=b.value;break;case"type":this.osc.type=b.value}return this},a.play=function(){this.osc.start(0),this.playing=!0,this.process()},a.stop=function(){this.playing=!1},a.tone=function(){this.flag=!0},a.process=function(){var a,b;if(a=this.options.easing,clearTimeout(this.timer),this.playing){if(this.timer=setTimeout(this.process,10),this.flag)return this.gain.gain.value=1,void(this.flag=!1);b=d.round(this.gain.gain.value*a/(a+1),4),b!==this.gain.gain.value&&(this.gain.gain.value=b)}}}();var d={iOS:function(){return/(iPhone|iPad)/.test(navigator.userAgent)},config:function(b){b.config=function(){var b,c;switch(b=Array.prototype.slice.call(arguments),c=this,this.options=this.options?this.options:a.extend({},this.defaults),a.type(b[0])){case"string":return b.length<2?this.options[b[0]]:(this.options[b[0]]!==b[1]&&(this.options[b[0]]=b[1],this.trigger("change",{key:b[0],value:b[1]})),this.options);case"object":return a.each(b[0],function(a,b){c.config(a,b)}),this.options;case"undefined":return this.options}return this.options}},events:function(b,c){c=c||"_emitter_",b[c]=a(b),["on","off","trigger"].forEach(function(a){b[a]=function(){return this[c][a].apply(this[c],arguments),this}})},format:function(){var a=Array.prototype.slice.call(arguments);return a.shift().replace(/%s/g,function(){return a.length?a.shift():""})},times:function(a,b){for(var c=0;a>c;c++)b(c)},rebase:function(a,b){b.forEach(function(b){a[b]=a[b].bind(a)})},last:function(a){return a[a.length-1]},repeat:function(a,b){for(var c="";b--;)c+=a;return c},round:function(a,b){var c=parseInt("1"+d.repeat("0",b));return parseInt(a*c,10)/c},filter:function(b,c){var d={};return a.each(b,function(a,b){!0===c(b,a)&&(d[a]=b)}),d}};b.ToneGrid=c}(jQuery,this);